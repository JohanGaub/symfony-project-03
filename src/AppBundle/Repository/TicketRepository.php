<?php

namespace AppBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * TicketRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TicketRepository extends EntityRepository
{
    const MAX_RESULT = 10;


    /**
     * @param int $page
     * @param int $maxTickets
     * @return Paginator
     */
    public function getList($page = 1, $maxTickets = 10)
    {
        $q = $this->createQueryBuilder('t')
            ->orderBy('t.emergency', 'ASC')
            ->addOrderBy('t.id', 'DESC')
            ->setFirstResult(($page - 1) * $maxTickets)
            ->setMaxResults($maxTickets)
            ->getQuery();
        //exit(dump($q->getQuery()->getResult()));

        return new Paginator($q, $fetchJoinCollection = false);
    }

    /**
     * @return mixed
     */
    public function countTicketTotal()
    {
        $q = $this->createQueryBuilder('t')
            ->select('COUNT(t)')
            ->getQuery()->getSingleScalarResult();
        return $q;
    }

    /**
     * @param $page
     * @param $filter
     * @return \Doctrine\ORM\Query
     */
    public function getRowsByPage($page, $filter)
    {
        $query = $this->createQueryBuilder('t')
            ->select('dts', 'c', 'ct', 'u', 't', 'cp', 'o')
            ->join('t.status','dts', 't.status = dts.id')
            ->join('t.category','c','t.category = c.id')
            ->join('t.user','u','t.user = u.id')
            ->join('c.type', 'ct', 'c.type = ct.id')
            ->join('u.company', 'cp', 'u.company = cp.id')
            ->join('t.origin', 'o', 't.origin = o.id')
            ->orderBy('t.id', 'DESC')
            ->setFirstResult(($page - 1) * self::MAX_RESULT)
            ->setMaxResults(self::MAX_RESULT);
        if(!is_null($filter)) {
            foreach ($filter as $field => $value) {
                if($value !== '') {
                    if(strpos($field, '_') !== 0) {
                        switch($field) {
                            case 'status':
                                $alias = 'dts';
                                $field = 'id';
                                $operator = "=";
                                break;
                            case 'categoryType':
                                $alias = 'ct';
                                $field = 'id';
                                $operator = "=";
                                break;
                            case 'category':
                                $alias = 'c';
                                $field = 'id';
                                $operator = "=";
                                break;
                            case 'company':
                                $alias = 'cp';
                                $field = 'name';
                                $operator = "like";
                                break;
                            case 'origin':
                                $alias = 'o';
                                $field = 'id';
                                $operator = "=";
                                break;
                            default:
                                $alias = 't';
                                $operator = "like";
                        }
                        if ($field == "creationDate" || $field == "endDate") {
                            $tabDate = explode('/' , $value);
                            $value  = $tabDate[2].'-'.$tabDate[1].'-'.$tabDate[0];
                            $date = new \DateTime(date("Y-m-d", strtotime($value)));
                            $search = "$alias.$field >= '" . $date->format("Y-m-d 00:00:00") . "'";
                            $query->andWhere($search);
                            $search = "$alias.$field <= '" . $date->format("Y-m-d 23:59:59") . "'";
                            $query->andWhere($search);
                        } elseif ($alias == 't' or $alias == 'cp') {
                            $search = "$alias.$field $operator '%$value%'";
                            $query->andWhere($search);
                        } else {
                            $search = "$alias.$field = '$value'";
                            $query->andWhere($search);
                        }
                    }
                }
            }
        }
        return $query->getQuery();
    }

}
